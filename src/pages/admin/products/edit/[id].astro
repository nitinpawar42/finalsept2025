---
import AdminLayout from '../../../../layouts/AdminLayout.astro';
import { db } from '../../../../firebase/admin';

const { id } = Astro.params;
const productRef = db.collection('products').doc(id);
const productDoc = await productRef.get();

if (!productDoc.exists) {
  return Astro.redirect('/admin/products');
}

const product = { id: productDoc.id, ...productDoc.data() };
---

<AdminLayout title={`Edit ${product.name}`}>
  <div class="container mx-auto">
    <h1 class="text-2xl font-bold mb-6">Edit Product</h1>

    <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md">
      <form id="edit-product-form">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <input type="text" name="name" value={product.name} class="w-full px-3 py-2 border rounded-lg" required>
          <input type="number" name="price" value={product.price} class="w-full px-3 py-2 border rounded-lg" required>
          <input type="number" name="weight" value={product.weight} class="w-full px-3 py-2 border rounded-lg" required>
          <input type="number" name="length" value={product.dimensions.length} class="w-full px-3 py-2 border rounded-lg" required>
          <input type="number" name="breadth" value={product.dimensions.breadth} class="w-full px-3 py-2 border rounded-lg" required>
          <input type="number" name="height" value={product.dimensions.height} class="w-full px-3 py-2 border rounded-lg" required>
          <textarea name="description" class="w-full px-3 py-2 border rounded-lg md:col-span-2" required>{product.description}</textarea>
          <div class="md:col-span-2">
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Current Image</label>
            <img src={product.imageUrl} alt={product.name} class="w-32 h-32 object-cover rounded-md my-2"/>
            <input type="file" name="image" accept="image/*" class="w-full px-3 py-2 border rounded-lg">
          </div>
        </div>
        <button type="submit" class="mt-4 w-full bg-indigo-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-indigo-700">Update Product</button>
      </form>
    </div>
  </div>

  <script>
    document.getElementById('edit-product-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      const form = e.target as HTMLFormElement;
      const formData = new FormData(form);
      const id = window.location.pathname.split('/').pop();

      const response = await fetch(`/api/products/${id}`,
      {
        method: 'PUT',
        body: formData,
      });

      if (response.ok) {
        window.location.href = '/admin/products';
      } else {
        const error = await response.json();
        alert(`Error: ${error.message}`);
      }
    });
  </script>
</AdminLayout>
